<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-06-22 Wed 16:07 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multi- to Monorepo Migration</title>
<meta name="description" content="Migrate your multirepo to a monorepo using a bash script" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link rel=stylesheet href=./style.css>
<meta name=color-scheme content="light dark">
<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
// @license-end
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Multi- to Monorepo Migration</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org9451c55">1. Features</a></li>
<li><a href="#orgc795793">2. Usage</a>
<ul>
<li><a href="#org262a9c1">2.1. Custom name for monorepo directory</a></li>
<li><a href="#orgeb6e00f">2.2. Custom “master” / “main” branch name</a></li>
<li><a href="#org120fb98">2.3. Continue existing migration</a></li>
</ul>
</li>
<li><a href="#org1afa462">3. Example</a>
<ul>
<li><a href="#org60971cb">3.1. Initial setup of fake repos</a></li>
<li><a href="#orgc19809d">3.2. Combine into monorepo</a></li>
<li><a href="#orgefedb0e">3.3. Pull in new changes from a remote</a></li>
<li><a href="#orgab5ae40">3.4. Continue</a></li>
<li><a href="#org6a5d484">3.5. Tags</a></li>
</ul>
</li>
<li><a href="#org9841d07">4. Implementation</a>
<ul>
<li><a href="#orgefb29e6">4.1. Per repository</a></li>
<li><a href="#orgf5a7944">4.2. Per branch (this is where the magic happens)</a>
<ul>
<li><a href="#org3f5ac5b">4.2.1. Ensure we are on the right branch</a></li>
</ul>
</li>
<li><a href="#org123b027">4.3. Set up the monorepo directory</a></li>
<li><a href="#orgaa72658">4.4. List individual branches</a>
<ul>
<li><a href="#orgc88586a">4.4.1. Implementations that didn’t make the cut</a></li>
</ul>
</li>
<li><a href="#org57d8677">4.5. Tags</a></li>
<li><a href="#orgbfaaad3">4.6. Init &amp; finalize</a>
<ul>
<li><a href="#org879c989">4.6.1. Error flags, warnings, debug</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org88ec20f">5. Copyright and license</a></li>
</ul>
</div>
</nav>
<p>
This script merges multiple independent tiny repositories into a single &ldquo;monorepo&rdquo;. The summary is “every repo is moved into its own subdirectory, branches are merged.” See <a href="#org1afa462">Example</a> for exactly how this works.
</p>

<p>
Further reading: <a href="https://syslog.ravelin.com/multi-to-mono-repository-c81d004df3ce">https://syslog.ravelin.com/multi-to-mono-repository-c81d004df3ce</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">$ cat my-repos.txt
git@github.com:mycompany/my-repo-abc.git abc
git@github.com:mycompany/my-repo-def.git def
$ /path/to/tomono &lt; my-repos.txt

... noise noise noise

$ cd core <span class="org-comment-delimiter"># </span><span class="org-comment">your monorepo is here now</span>
</pre>
</div>

<div id="outline-container-org9451c55" class="outline-2">
<h2 id="org9451c55"><span class="section-number-2">1.</span> Features</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>🕙 Full history of all your prior repos is intact, no changes to checksums</li>
<li>#️⃣ Signatures of old repos stay valid</li>
<li>🔁 Create the monorepo and keep pulling in changes from your minirepos later</li>
<li>🔀 Pull in entire new repos as you go, no need to prepare the whole thing at once</li>
<li>🉑 Branches with weird names (slashes, etc)</li>
<li>👥 No conflicts between files with the same name</li>
<li>📁 Every project gets its own subdirectory</li>
</ul>
</div>
</div>

<div id="outline-container-orgc795793" class="outline-2">
<h2 id="orgc795793"><span class="section-number-2">2.</span> Usage</h2>
<div class="outline-text-2" id="text-2">
<p>
Run the <code>tomono</code> script with your config on stdin, in the following format:
</p>

<pre class="example" id="org5ad1ae2">
git@github.com:mycompany/my-repo-abc.git  abc
git@github.com:mycompany/my-repo-def.git  def
git@github.com:mycompany/my-lib-uuu.git   uuu  lib/uuu
git@github.com:mycompany/my-lib-zzz.git   zzz  lib/zzz
</pre>

<p>
Concrete example:
</p>

<div class="org-src-container">
<pre class="src src-shell">$ cat my-repos.txt | /path/to/tomono
</pre>
</div>

<p>
That should be all ✅.
</p>
</div>

<div id="outline-container-org262a9c1" class="outline-3">
<h3 id="org262a9c1"><span class="section-number-3">2.1.</span> Custom name for monorepo directory</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Don’t like <code>core</code>? Set a different name through an envvar before running the script:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">export</span> <span class="org-variable-name">MONOREPO_NAME</span>=the-big-repo
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeb6e00f" class="outline-3">
<h3 id="orgeb6e00f"><span class="section-number-3">2.2.</span> Custom “master” / “main” branch name</h3>
<div class="outline-text-3" id="text-2-2">
<p>
No need to do anything. This script does not handle any master / main branch in any special way. It just merges whatever branches exist. Don’t have a “master” branch? None will be created.
</p>

<p>
Make sure your own computer has the right branch set up in its <code>init.defaultBranch</code> setting.
</p>
</div>
</div>

<div id="outline-container-org120fb98" class="outline-3">
<h3 id="org120fb98"><span class="section-number-3">2.3.</span> Continue existing migration</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Large teams can’t afford to “stop the world” while a migration is in progress. You’ll be fixing stuff and pulling in new repositories as you go.
</p>

<p>
Here’s how to pull in an entirely new set of repositories:
</p>

<div class="org-src-container">
<pre class="src src-shell">/path/to/tomono --continue &lt; my-new-repos.txt
</pre>
</div>

<p>
Make sure you have your environment set up exactly the same as above. Particularly, you must be in the parent dir of the monorepo.
</p>
</div>
</div>
</div>

<div id="outline-container-org1afa462" class="outline-2">
<h2 id="org1afa462"><span class="section-number-2">3.</span> Example</h2>
<div class="outline-text-2" id="text-3">
<p>
Run these commands to set up a fresh directory with git monorepos that you can later merge:
</p>
</div>

<div id="outline-container-org60971cb" class="outline-3">
<h3 id="org60971cb"><span class="section-number-3">3.1.</span> Initial setup of fake repos</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-variable-name">d</span>=<span class="org-string">"$(mktemp -d)"</span>
<span class="org-builtin">echo</span> <span class="org-string">"Setting up fresh multi-repos in $d"</span>
<span class="org-builtin">cd</span> <span class="org-string">"$d"</span>

mkdir foo
(
    <span class="org-builtin">cd</span> foo
    git init
    git commit -m <span class="org-string">"foo&#8217;s empty root"</span> --allow-empty
    <span class="org-builtin">echo</span> <span class="org-string">"This is foo"</span> &gt; i-am-foo.txt
    git add -A
    git commit -m <span class="org-string">"foo&#8217;s master"</span>
    git checkout -b branch-a
    <span class="org-builtin">echo</span> <span class="org-string">"I am a new foo feature"</span> &gt; feature-a.txt
    git add -A
    git commit -m <span class="org-string">"foo&#8217;s feature branch A"</span>
)

mkdir bar
(
    <span class="org-builtin">cd</span> bar
    git init
    <span class="org-builtin">echo</span> <span class="org-string">"This is bar"</span> &gt; i-am-bar.txt
    git add -A
    git commit -m <span class="org-string">"bar&#8217;s master"</span>
    git checkout -b branch-a
    <span class="org-builtin">echo</span> <span class="org-string">"I am bar&#8217;s side of feature A"</span> &gt; feature-a.txt
    git add -A
    git commit -m <span class="org-string">"bar&#8217;s feature branch A"</span>
    git branch branch-b master
    git checkout branch-b
    <span class="org-builtin">echo</span> <span class="org-string">"I am an entirely new feature of bar: B"</span> &gt; feature-b.txt
    git add -A
    git commit -m <span class="org-string">"bar&#8217;s feature branch B"</span>
)
</pre>
</div>

<p>
You now have two directories:
</p>

<ul class="org-ul">
<li><code>foo</code> (branches: <code>master</code>, <code>branch-a</code>)</li>
<li><code>bar</code> (branches: <code>master</code>, <code>branch-a</code>, <code>branch-b</code>)</li>
</ul>
</div>
</div>

<div id="outline-container-orgc19809d" class="outline-3">
<h3 id="orgc19809d"><span class="section-number-3">3.2.</span> Combine into monorepo</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Assuming the <code>tomono</code> script is in your <code>$PATH</code>, you can invoke it like this, from that same directory:
</p>

<div class="org-src-container">
<pre class="src src-shell">tomono &lt;&lt;EOF
<span class="org-sh-heredoc">$PWD/foo foo</span>
<span class="org-sh-heredoc">$PWD/bar bar</span>
<span class="org-sh-heredoc">EOF</span>
</pre>
</div>

<p>
This will create a new directory, <code>core</code>, where you can find a git tree which looks somewhat like this:
</p>

<pre class="example" id="org3af67f4">
*   Merge foo/branch-a (branch-a)
|\
| * foo’s feature branch A (foo/branch-a)
* |   Merge bar/branch-a
|\ \
| * | bar’s feature branch A (bar/branch-a)
* | | Root commit for monorepo branch branch-a
 / /
| | *   Merge foo/master (HEAD -&gt; master)
| | |\
| | |/
| |/|
| * | foo’s master (foo/master)
| * | foo’s empty root
|  /
| *   Merge bar/master
| |\
| |/
|/|
| * Root commit for monorepo branch master
| *   Merge bar/branch-b (branch-b)
| |\
| | * bar’s feature branch B (bar/branch-b)
| |/
|/|
* | bar’s master (bar/master)
 /
* Root commit for monorepo branch branch-b
</pre>
</div>
</div>

<div id="outline-container-orgefedb0e" class="outline-3">
<h3 id="orgefedb0e"><span class="section-number-3">3.3.</span> Pull in new changes from a remote</h3>
<div class="outline-text-3" id="text-3-3">
<p>
It’s possible that while you’re working on setting up your fresh monorepo, new changes have been pushed to the existing single repos:
</p>

<div class="org-src-container">
<pre class="src src-shell">(
        <span class="org-builtin">cd</span> foo
        <span class="org-builtin">echo</span> New changes &gt;&gt; i-am-foo.txt
        git commit -va -m <span class="org-string">'New changes to foo'</span>
)
</pre>
</div>

<p>
Because their history was imported verbatim and nothing has been rewritten, you can import those changes into the monorepo.
</p>

<p>
First, fetch the changes from the remote:
</p>

<div class="org-src-container">
<pre class="src src-shell">$ cd core
$ git fetch foo
</pre>
</div>

<p>
Now merge your changes using subtree merge:
</p>

<div class="org-src-container">
<pre class="src src-shell">git checkout master
git merge -X <span class="org-variable-name">subtree</span>=foo/ foo/master
</pre>
</div>

<p>
And the updates should be reflected in the monorepo:
</p>

<div class="org-src-container">
<pre class="src src-shell">$ cat foo/i-am-foo.txt
This is foo
New changes
</pre>
</div>

<p>
I used the branch master in this example, but any branch works the same way.
</p>
</div>
</div>

<div id="outline-container-orgab5ae40" class="outline-3">
<h3 id="orgab5ae40"><span class="section-number-3">3.4.</span> Continue</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Now imagine you want to pull in a third repository into the monorepo:
</p>

<div class="org-src-container">
<pre class="src src-shell">mkdir zimlib
(
    <span class="org-builtin">cd</span> zimlib
    git init
    <span class="org-builtin">echo</span> <span class="org-string">"This is zim"</span> &gt; i-am-zim.txt
    git add -A
    git commit -m <span class="org-string">"zim&#8217;s master"</span>
    git checkout -b branch-a
    <span class="org-builtin">echo</span> <span class="org-string">"I am a new zim feature"</span> &gt; feature-a.txt
    git add -A
    git commit -m <span class="org-string">"zim&#8217;s feature branch A"</span>
    git checkout --orphan empty-branch
    git rm --cached -r .
    git commit -m <span class="org-string">"zim&#8217;s tricky empty orphan branch"</span> --allow-empty
)
</pre>
</div>

<p>
Continue importing it:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">echo</span> <span class="org-string">"$PWD/zimlib zim lib/zim"</span> | /path/to/tomono --continue
</pre>
</div>

<p>
Note that we used a different name for this subrepo, inside the <code>lib</code> dir.
</p>

<p>
The result is that it gets imported into the existing monorepo, alongside the existing two projects:
</p>

<pre class="example" id="org3bf9db2">
$ cd core
$ git checkout master
Switched to branch 'master'
$ tree
.
├── bar
│   └── i-am-bar.txt
├── foo
│   └── i-am-foo.txt
└── lib
    └── zim
        └── i-am-zim.txt

4 directories, 3 files
$ git checkout branch-a
Switched to branch 'branch-a'
$ tree
.
├── bar
│   ├── feature-a.txt
│   └── i-am-bar.txt
├── foo
│   ├── feature-a.txt
│   └── i-am-foo.txt
└── lib
    └── zim
        ├── feature-a.txt
        └── i-am-zim.txt

4 directories, 6 files
$ head **/feature-a.txt
==&gt; bar/feature-a.txt &lt;==
I am bar’s side of feature A

==&gt; foo/feature-a.txt &lt;==
I am a new foo feature

==&gt; lib/zim/feature-a.txt &lt;==
I am a new zim feature
</pre>
</div>
</div>

<div id="outline-container-org6a5d484" class="outline-3">
<h3 id="org6a5d484"><span class="section-number-3">3.5.</span> Tags</h3>
<div class="outline-text-3" id="text-3-5">
<p>
Tags are namespaced per remote, to avoid clashes. If your remote <code>foo</code> and <code>bar</code> both have a tag <code>v1.0.0</code>, your monorepo ends up with <code>foo/v1.0.0</code> and <code>bar/v1.0.0</code> pointing at their relevant commits.
</p>

<p>
N.B.: This concerns light-weight tags! Annotated tags are a different beast and unfortunately they can’t be rewritten this way.
</p>

<p>
If you don’t like this rewriting, you can remove all tags, and fetch them fresh from the remotes:
</p>

<div class="org-src-container">
<pre class="src src-shell">$ cat ... |  .../tomono
$ cd core
$ rm -rf .git/refs/tags
$ git fetch --all --tags
</pre>
</div>

<p>
Be prepared to deal with any conflicts!
</p>
</div>
</div>
</div>

<div id="outline-container-org9841d07" class="outline-2">
<h2 id="org9841d07"><span class="section-number-2">4.</span> Implementation</h2>
<div class="outline-text-2" id="text-4">
<blockquote>
<p>
(This section is best viewed at <a href="https://hraban.github.io/tomono/">https://hraban.github.io/tomono/</a>, the GitHub Readme viewer misses some info)
</p>
</blockquote>

<p>
The outer program structure is a flat bash script which loops over every repo supplied over stdin:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>top-level</label><pre class="src src-shell" id="orga82eeaa">&lt;&lt;init&gt;&gt;

<span class="org-comment-delimiter"># </span><span class="org-comment">Note this is top-level in the script so it&#8217;s reading from the script&#8217;s stdin</span>
<span class="org-keyword">while </span><span class="org-builtin">read</span> repourl reponame repopath; <span class="org-keyword">do</span>
    <span class="org-keyword">if</span> [[ -z <span class="org-string">"$repopath"</span> ]]; <span class="org-keyword">then</span>
        <span class="org-variable-name">repopath</span>=<span class="org-string">"$reponame"</span>
    <span class="org-keyword">fi</span>

    &lt;&lt;handle-remote&gt;&gt;
<span class="org-sh-heredoc">done</span>

<span class="org-sh-heredoc">&lt;&lt;finalize&gt;&gt;</span>

<span class="org-sh-heredoc"># &lt;&lt;copyright&gt;&gt;</span>
</pre>
</div>
<p>
References: <a href="#org4925cdf">init</a>, <a href="#org1014e1d">handle-remote</a>, <a href="#org08973d5">finalize</a>, <a href="#org8ad3376">copyright</a>
</p>
</div>


<div id="outline-container-orgefb29e6" class="outline-3">
<h3 id="orgefb29e6"><span class="section-number-3">4.1.</span> Per repository</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Every repository is fetched and fully handled individually, and sequentially:
</p>

<ol class="org-ol">
<li>fetch all the data related to this repository,</li>
<li>immediately check out and initialise every single branch which belongs to that repository.</li>
</ol>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>handle-remote</label><pre class="src src-shell" id="org1014e1d">git remote add <span class="org-string">"$reponame"</span> <span class="org-string">"$repourl"</span>
git fetch --tags --atomic <span class="org-string">"$reponame"</span>
&lt;&lt;namespace-remote-tags&gt;&gt;
<span class="org-sh-heredoc">&lt;&lt;list-branches&gt;&gt; | while read branch ; do</span>
<span class="org-sh-heredoc">    &lt;&lt;handle-branch&gt;&gt;</span>
<span class="org-sh-heredoc">done</span>
</pre>
</div>
<p>
References: <a href="#org5d941e6">namespace-remote-tags</a>, <a href="#org8233fe2">list-branches</a>, <a href="#orgdea849c">handle-branch</a>
</p>

<p>
Used by: <a href="#orga82eeaa">top-level</a>
</p>
</div>
</div>


<div id="outline-container-orgf5a7944" class="outline-3">
<h3 id="orgf5a7944"><span class="section-number-3">4.2.</span> Per branch (this is where the magic happens)</h3>
<div class="outline-text-3" id="text-4-2">
<p>
In the context of <i>a single repository check-out</i>, every branch is independently checked out into a subdir for that repository, and merged into the monorepo.
</p>

<p>
This is the money shot.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>handle-branch</label><pre class="src src-shell" id="orgdea849c">&lt;&lt;ensure-on-target-branch-in-monorepo&gt;&gt;

git merge --strategy=ours <span class="org-string">"$reponame/$branch"</span> --allow-unrelated-histories --no-commit --no-ff
git read-tree --prefix <span class="org-string">"$repopath"</span> <span class="org-string">"$reponame/$branch"</span>
git commit -m <span class="org-string">"Merge $reponame/$branch"</span> --allow-empty
</pre>
</div>
<p>
References: <a href="#org59a1ac2">ensure-on-target-branch-in-monorepo</a>
</p>

<p>
Used by: <a href="#org1014e1d">handle-remote</a>
</p>


<p>
Source: <a href="https://git-scm.com/book/en/v2/Git-Internals-Git-Objects">https://git-scm.com/book/en/v2/Git-Internals-Git-Objects</a>
</p>
</div>

<div id="outline-container-org3f5ac5b" class="outline-4">
<h4 id="org3f5ac5b"><span class="section-number-4">4.2.1.</span> Ensure we are on the right branch</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
In this snippet, we ensure that we are ready to merge fresh code from a subrepo into this branch: either we checkout an existing branch in the monorepo by this name, or we create a fresh one.
</p>

<p>
We are given the variable <code>$branch</code> which is the final name of the branch we want to operate on. It is the same as the name of the branch in each individual target repo.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>ensure-on-target-branch-in-monorepo</label><pre class="src src-shell" id="org59a1ac2"><span class="org-keyword">if</span> <span class="org-negation-char">!</span> git show-ref --verify --quiet <span class="org-string">"refs/heads/$branch"</span>; <span class="org-keyword">then</span>
    git branch -- <span class="org-string">"$branch"</span> <span class="org-string">"$(printf "Root commit for monorepo branch %s" "$branch" | git commit-tree "$empty_tree")"</span>
<span class="org-keyword">fi</span>
git symbolic-ref HEAD <span class="org-string">"refs/heads/$branch"</span>
git reset
</pre>
</div>
<p>
Used by: <a href="#orgdea849c">handle-branch</a>
</p>


<p>
Instead of using <code>git checkout --orphan</code> and trying to create a new empty commit from the index, we create the empty commit first, and update the HEAD to it directly. This lets us stay entirely in the index without bothering with the work tree.
</p>

<p>
Sources:
</p>
<ul class="org-ul">
<li><a href="https://stackoverflow.com/q/9765453/4359699">https://stackoverflow.com/q/9765453/4359699</a></li>
<li><a href="https://stackoverflow.com/a/6070417/4359699">https://stackoverflow.com/a/6070417/4359699</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org123b027" class="outline-3">
<h3 id="org123b027"><span class="section-number-3">4.3.</span> Set up the monorepo directory</h3>
<div class="outline-text-3" id="text-4-3">
<p>
We create a fresh directory for this script to run in, or continue on an existing one if the <code>--continue</code> flag is passed.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>prep-dir</label><pre class="src src-shell" id="org1b773be"><span class="org-comment-delimiter"># </span><span class="org-comment">Poor man&#8217;s arg parse :/</span>
<span class="org-variable-name">arg</span>=<span class="org-string">"${1-}"</span>
: <span class="org-string">"${MONOREPO_NAME:=core}"</span>

<span class="org-keyword">if</span> [[ <span class="org-string">"$arg"</span> == <span class="org-string">""</span> ]]; <span class="org-keyword">then</span>
        <span class="org-keyword">if</span> [[ -d <span class="org-string">"$MONOREPO_NAME"</span> &amp;&amp; <span class="org-string">"$arg"</span> != <span class="org-string">"--continue"</span> ]]; <span class="org-keyword">then</span>
                &gt;&amp;2 echo <span class="org-string">"monorepo directory $MONOREPO_NAME already exists"</span>
                <span class="org-keyword">exit</span> 1
        <span class="org-keyword">fi</span>
        mkdir <span class="org-string">"$MONOREPO_NAME"</span>
        <span class="org-builtin">cd</span> <span class="org-string">"$MONOREPO_NAME"</span>
        git init
<span class="org-keyword">elif</span> [[ <span class="org-string">"$arg"</span> != <span class="org-string">"--continue"</span> ]]; <span class="org-keyword">then</span>
        &gt;&amp;2 echo <span class="org-string">"Unexpected argument: $arg"</span>
        &gt;&amp;2 echo
        &gt;&amp;2 echo <span class="org-string">"Usage: $0 [--continue]"</span>
        <span class="org-keyword">exit</span> 1
<span class="org-keyword">elif</span> [[ <span class="org-negation-char">!</span> -d <span class="org-string">"$MONOREPO_NAME"</span> ]]; <span class="org-keyword">then</span>
        &gt;&amp;2 echo <span class="org-string">"Asked to --continue, but monorepo directory $MONOREPO_NAME doesn&#8217;t exist"</span>
        <span class="org-keyword">exit</span> 1
<span class="org-keyword">else</span>
        <span class="org-builtin">cd</span> <span class="org-string">"$MONOREPO_NAME"</span>
        <span class="org-keyword">if</span> git status --porcelain | grep . ; <span class="org-keyword">then</span>
                &gt;&amp;2 echo <span class="org-string">"Git status shows pending changes in the repo. Cannot --continue."</span>
                <span class="org-keyword">exit</span> 1
        <span class="org-keyword">fi</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">There isn&#8217;t anything special about --continue, really.</span>
<span class="org-keyword">fi</span>
</pre>
</div>
<p>
Used by: <a href="#org4925cdf">init</a>
</p>


<p>
Most of rigmarole is about UI, and preventing mistakes. As you can see, there is functionally no difference between continuing and starting fresh, beyond <code>mkdir</code> and <code>git init</code>. At the end of the day, every repo is read in greedily, and whether you do that on an existing monorepo, or a fresh one, doesn’t matter: every repo name you read in, is in fact itself like a <code>--continue</code> operation.
</p>

<p>
It’s horrible and kludgy but I just want to get something working out the door, for now.
</p>
</div>
</div>

<div id="outline-container-orgaa72658" class="outline-3">
<h3 id="orgaa72658"><span class="section-number-3">4.4.</span> List individual branches</h3>
<div class="outline-text-3" id="text-4-4">
<p>
I want a single branch name per line on stdout, for a single specific remote:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>list-branches</label><pre class="src src-shell" id="org8233fe2">git branch -r --no-color --list <span class="org-string">"$reponame/*"</span> --format <span class="org-string">"%(refname:lstrip=3)"</span>
</pre>
</div>
<p>
Used by: <a href="#org1014e1d">handle-remote</a>
</p>
</div>


<div id="outline-container-orgc88586a" class="outline-4">
<h4 id="orgc88586a"><span class="section-number-4">4.4.1.</span> Implementations that didn’t make the cut</h4>
<div class="outline-text-4" id="text-4-4-1">
<p>
Solutions I abandoned, due to one short-coming or another:
</p>
</div>

<ol class="org-ol">
<li><a id="orgad18691"></a><code>git branch -r</code> with grep<br>
<div class="outline-text-5" id="text-4-4-1-1">
<p>
The most straight-forward way to list branch names:
</p>

<div class="org-src-container">
<pre class="src src-shell">$ git branch -r
  bar/branch-a
  bar/branch-b
  bar/master
  foo/branch-a
  foo/master
</pre>
</div>

<p>
This could be combined with <code>grep</code> to filter all branches for a specific remote, and filter out the name. It’s very close, but how do you reliably remove an unknown string?
</p>
</div>
</li>

<li><a id="org3c520ae"></a><code>find .git/refs/hooks</code><br>
<div class="outline-text-5" id="text-4-4-1-2">
<div class="org-src-container">
<pre class="src src-shell">( <span class="org-builtin">cd</span> <span class="org-string">".git/refs/remotes/$reponame"</span> &amp;&amp; find . -type f -mindepth 1 | sed -e s/..// )
</pre>
</div>

<p>
Closer, but ugly, and I got reports that it missed some branches (although I was never able to repro)
</p>
</div>
</li>

<li><a id="org913cab3"></a><code>git ls-remote</code><br>
<div class="outline-text-5" id="text-4-4-1-3">
<div class="org-src-container">
<pre class="src src-shell">git ls-remote --heads --refs <span class="org-string">"$reponame"</span> | sed <span class="org-string">'s_[^ ]* *refs/heads/__'</span>
</pre>
</div>

<p>
Originally suggested in a <a href="https://github.com/hraban/tomono/pull/39">PR 39</a>, I’ve decided not to use this because <code>git-ls-remote</code> actively queries the remote to list its branches, rather than inspecting the local state of whatever we just fetched. That feels like a race condition at best, and becomes very annoying if you’re dealing with password protected remotes or otherwise inaccessible repos.
</p>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org57d8677" class="outline-3">
<h3 id="org57d8677"><span class="section-number-3">4.5.</span> Tags</h3>
<div class="outline-text-3" id="text-4-5">
<p>
Light weight tags are just refs, and they’re all stored in a predictable place in the <code>.git</code> directory. The easiest way to manage them is to juggle that directory after each fetch.
</p>

<p>
We start by storing all our existing tags somewhere out of git’s reach:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>prep-tags</label><pre class="src src-shell" id="org33316a3">(
        <span class="org-builtin">cd</span> .git/refs
        mv tags tags-aux
)
</pre>
</div>
<p>
Used by: <a href="#org4925cdf">init</a>
</p>


<p>
and once everything is done, we move them back:
</p>


<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>finalize-tags</label><pre class="src src-shell" id="org8783df4">(
        <span class="org-builtin">cd</span> .git/refs
        mv tags-aux tags
)
</pre>
</div>
<p>
Used by: <a href="#org08973d5">finalize</a>
</p>


<p>
The real magic happens just after a remote has been fetched (see <a href="#org1014e1d"><code>handle-remote</code></a>). We now know for sure that all tags actually only belong to that remote, so we can namespace them all together:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>namespace-remote-tags</label><pre class="src src-shell" id="org5d941e6">(
        <span class="org-builtin">cd</span> .git/refs
        <span class="org-keyword">if</span> [[ -d tags ]]; <span class="org-keyword">then</span>
                <span class="org-variable-name">tagdir</span>=<span class="org-string">"tags-aux/$reponame"</span>
                mkdir -p <span class="org-string">"$tagdir"</span>
                rmdir <span class="org-string">"$tagdir"</span>
                mv tags <span class="org-string">"$tagdir"</span>
        <span class="org-keyword">fi</span>
)
</pre>
</div>
<p>
Used by: <a href="#org1014e1d">handle-remote</a>
</p>


<p>
The <code>mkdir -p .. ; rmdir ..</code> trick is the easiest way to create a directory’s parent, without creating the directory itself. I don’t like process substitution (<code>mkdir "$(dirname ...)"</code>, yuck).
</p>
</div>
</div>

<div id="outline-container-orgbfaaad3" class="outline-3">
<h3 id="orgbfaaad3"><span class="section-number-3">4.6.</span> Init &amp; finalize</h3>
<div class="outline-text-3" id="text-4-6">
<p>
Initialization is what you’d expect from a shell script:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>init</label><pre class="src src-shell" id="org4925cdf">&lt;&lt;set-flags&gt;&gt;

&lt;&lt;prep-dir&gt;&gt;

<span class="org-sh-heredoc">&lt;&lt;prep-tags&gt;&gt;</span>

<span class="org-sh-heredoc">empty_tree="$(git hash-object -t tree /dev/null)"</span>
</pre>
</div>
<p>
References: <a href="#orgd707c52">set-flags</a>, <a href="#org1b773be">prep-dir</a>, <a href="#org33316a3">prep-tags</a>
</p>

<p>
Used by: <a href="#orga82eeaa">top-level</a>
</p>


<p>
On the other side, when done, clean up the tags and update the working tree to whatever the current branch is to avoid any confusion:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>finalize</label><pre class="src src-shell" id="org08973d5">&lt;&lt;finalize-tags&gt;&gt;

git checkout .
</pre>
</div>
<p>
References: <a href="#org8783df4">finalize-tags</a>
</p>

<p>
Used by: <a href="#orga82eeaa">top-level</a>
</p>
</div>


<div id="outline-container-org879c989" class="outline-4">
<h4 id="org879c989"><span class="section-number-4">4.6.1.</span> Error flags, warnings, debug</h4>
<div class="outline-text-4" id="text-4-6-1">
<p>
Various sh flags allow us to control the behaviour of the shell: treat
any unknown variable reference as an error, treat any non-zero exit
status in a pipeline as an error (instead of only looking at the last
program), and treat any error as fatal and quit. Additionally, if the
<code>DEBUGSH</code> environment variable is set, enable &ldquo;debug&rdquo; mode by echoing
every command before it gets executed.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>set-flags</label><pre class="src src-shell" id="orgd707c52"><span class="org-builtin">set</span> -euo pipefail ${<span class="org-variable-name">DEBUGSH</span>+-x}
</pre>
</div>
<p>
Used by: <a href="#org4925cdf">init</a>
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org88ec20f" class="outline-2">
<h2 id="org88ec20f"><span class="section-number-2">5.</span> Copyright and license</h2>
<div class="outline-text-2" id="text-5">
<p>
This is a cleanroom reimplementation of the tomono.sh script, originally written with copyright assigned to Ravelin Ltd., a UK fraud detection company. There were some questions around licensing, and it was unclear how to go forward with maintenance of this project given its dispersed copyright, so I went ahead and rewrote the entire thing for a fresh start.
</p>

<p>
The license and copyright attribution of this entire document can now be set:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>copyright</label><pre class="src src-fundamental" id="org8ad3376">Copyright &#169; 2020, 2022 Hraban Luyat

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, version 3 of the License.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <a href="https://www.gnu.org/licenses/">&lt;https://www.gnu.org/licenses/&gt;</a>.
</pre>
</div>
<p>
Used by: <a href="#orga82eeaa">top-level</a>
</p>


<p>
I did not look at the original implementation at all while developing this.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2022-06-22 Wed 16:07</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 28.1 (<a href="https://orgmode.org">Org</a> mode 9.5.2)</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
